{% extends 'base.html' %}
{% block content %}
<section class="hero">
  <div class="card">
    <h2>판매 데이터 대시보드</h2>
    <p>폴더 자동 수집: `data/raw`에 엑셀(.xlsx) 또는 CSV를 넣고 아래 버튼을 눌러 최신 데이터를 반영하세요.</p>
    <p>결제일시/결제금액/환불지급액 기준으로 주별·월별 매출과 객단가를 계산합니다.</p>
    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <form method="post">
        <input type="hidden" name="action" value="ingest">
        <button class="btn" type="submit">엑셀 자동 불러오기</button>
      </form>
      <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="action" value="upload">
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
          <label style="font-size:13px; font-weight:600;">
            파일 선택
            <input type="file" name="data_files" accept=".xlsx,.csv" multiple>
          </label>
          <label style="font-size:13px; font-weight:600;">
            폴더 선택
            <input type="file" name="data_folder" webkitdirectory directory>
          </label>
          <button class="btn alt" type="submit">업로드 반영</button>
        </div>
        <p style="margin-top:6px; font-size:12px; color:#667085;">
          폴더 업로드는 Chrome/Edge 권장 (폴더 내 .xlsx/.csv만 처리)
        </p>
      </form>
    </div>
    {% if ingest_result %}
      <div style="margin-top:10px; font-size:14px; color:#475467;">
        처리 파일: {{ ingest_result.processed_files|join(', ') if ingest_result.processed_files else '없음' }}
        {% if ingest_result.skipped_files %}
          <br>이미 처리된 파일: {{ ingest_result.skipped_files|join(', ') }}
        {% endif %}
        {% if ingest_result.invalid_files %}
          <br>유효하지 않은 파일: {{ ingest_result.invalid_files|join(', ') }}
        {% endif %}
        <br>입력 건수: {{ ingest_result.inserted_rows }}
        {% if ingest_result.skipped_rows %}
          <br>무시된 행: {{ ingest_result.skipped_rows }}
        {% endif %}
      </div>
    {% endif %}
  </div>
  <div class="card">
    <h3>지표 정의</h3>
    <p>매출 = 결제금액 - 환불지급액 (순매출 기준)</p>
    <p>객단가 = 순매출 ÷ 거래 건수</p>
    <p style="font-size:13px; color:#667085;">※ 환불만 있는 건은 매출에서 차감되며, 객단가 계산은 결제금액이 있는 건만 포함됩니다.</p>
  </div>
</section>

<section class="grid-5">
  <div class="card kpi"><div class="label">총 매출</div><div class="value">{{ "{:,.0f}".format(metrics.total_sales) }}</div><span class="badge">원</span></div>
  <div class="card kpi"><div class="label">거래 건수</div><div class="value">{{ metrics.total_transactions }}</div><span class="badge">건</span></div>
  <div class="card kpi"><div class="label">객단가</div><div class="value">{{ "{:,.0f}".format(metrics.avg_order_value) }}</div><span class="badge">원</span></div>
  <div class="card kpi"><div class="label">환불 합계</div><div class="value">{{ "{:,.0f}".format(metrics.total_refunds) }}</div><span class="badge">원</span></div>
  <div class="card kpi"><div class="label">고유 회원</div><div class="value">{{ metrics.unique_members }}</div><span class="badge">명</span></div>
</section>

<section class="two-cols">
  <div class="card">
    <h3>주별 매출 & 객단가</h3>
    <canvas id="weeklyChart" height="140"></canvas>
  </div>
  <div class="card">
    <h3>월별 매출 & 객단가</h3>
    <canvas id="monthlyChart" height="140"></canvas>
  </div>
</section>

<section class="card" style="margin-top:16px;">
  <h3>최근 결제</h3>
  <table class="table">
    <thead><tr><th>회원</th><th>결제일</th><th>순매출</th></tr></thead>
    <tbody>
    {% for row in recent_records %}
      <tr>
        <td>{{ row.member_name }}</td>
        <td>{{ row.payment_date }}</td>
        <td>{{ "{:,.0f}".format(row.net_amount or 0) }}</td>
      </tr>
    {% else %}
      <tr><td colspan="3">데이터가 없습니다.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const weeklyLabels = {{ weekly_labels|safe }};
const weeklySales = {{ weekly_sales|safe }};
const weeklyAov = {{ weekly_aov|safe }};

const monthlyLabels = {{ monthly_labels|safe }};
const monthlySales = {{ monthly_sales|safe }};
const monthlyAov = {{ monthly_aov|safe }};

function buildSalesChart(canvasId, labels, salesData, aovData) {
  new Chart(document.getElementById(canvasId), {
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: '매출(원)',
          data: salesData,
          backgroundColor: 'rgba(38,89,255,.18)',
          borderColor: '#2659ff',
          borderWidth: 1
        },
        {
          type: 'line',
          label: '객단가(원)',
          data: aovData,
          borderColor: '#12b76a',
          backgroundColor: 'rgba(18,183,106,.1)',
          tension: .35,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

buildSalesChart('weeklyChart', weeklyLabels, weeklySales, weeklyAov);
buildSalesChart('monthlyChart', monthlyLabels, monthlySales, monthlyAov);
</script>
{% endblock %}
