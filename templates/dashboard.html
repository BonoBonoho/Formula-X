{% extends 'base.html' %}
{% block content %}
<section class="hero">
  <div class="card">
    <h2>바디코디 성과 대시보드</h2>
    <p>폴더 자동 수집: `data/raw`에 엑셀(.xlsx) 또는 CSV를 넣고 아래 버튼을 눌러 최신 데이터를 반영하세요.</p>
    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <form method="post">
        <input type="hidden" name="action" value="ingest">
        <button class="btn" type="submit">엑셀 자동 불러오기</button>
      </form>
      <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="action" value="upload">
        <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
          <label style="font-size:13px; font-weight:600;">
            파일 선택
            <input type="file" name="data_files" accept=".xlsx,.csv" multiple>
          </label>
          <label style="font-size:13px; font-weight:600;">
            폴더 선택
            <input type="file" name="data_folder" webkitdirectory directory>
          </label>
          <button class="btn alt" type="submit">업로드 반영</button>
        </div>
        <p style="margin-top:6px; font-size:12px; color:#667085;">
          폴더 업로드는 Chrome/Edge 권장 (폴더 내 .xlsx/.csv만 처리)
        </p>
      </form>
    </div>
    {% if ingest_result %}
      <div style="margin-top:10px; font-size:14px; color:#475467;">
        처리 파일: {{ ingest_result.processed_files|join(', ') if ingest_result.processed_files else '없음' }}
        {% if ingest_result.skipped_files %}
          <br>이미 처리된 파일: {{ ingest_result.skipped_files|join(', ') }}
        {% endif %}
        {% if ingest_result.invalid_files %}
          <br>유효하지 않은 파일: {{ ingest_result.invalid_files|join(', ') }}
        {% endif %}
        <br>입력 건수: {{ ingest_result.inserted_rows }}
        {% if ingest_result.skipped_rows %}
          <br>무시된 행: {{ ingest_result.skipped_rows }}
        {% endif %}
      </div>
    {% endif %}
  </div>
  <div class="card">
    <h3>성과 판단</h3>
    <p>종합점수는 출석률(40%) + 재구매율(35%) + CSAT환산(25%)로 계산됩니다.</p>
    {% set score_class = 'score-good' if metrics.performance_score >= 85 else ('score-mid' if metrics.performance_score >= 70 else 'score-bad') %}
    <h1 class="{{ score_class }}" style="margin-top:10px;">{{ metrics.performance_score }}</h1>
    <p>판단 결과: <strong>{{ metrics.judgment }}</strong></p>
  </div>
</section>

<section class="grid-4">
  <div class="card kpi"><div class="label">총 회원 수</div><div class="value">{{ metrics.total_members }}</div><span class="badge">전체 기준</span></div>
  <div class="card kpi"><div class="label">평균 출석률</div><div class="value">{{ metrics.avg_attendance }}%</div><span class="badge">Attendance</span></div>
  <div class="card kpi"><div class="label">평균 재구매율</div><div class="value">{{ metrics.avg_repurchase }}%</div><span class="badge">Repurchase</span></div>
  <div class="card kpi"><div class="label">평균 CSAT</div><div class="value">{{ metrics.avg_csat }}</div><span class="badge">/ 5.0</span></div>
</section>

<section class="two-cols">
  <div class="card">
    <h3>월별 KPI 추이</h3>
    <canvas id="kpiChart" height="120"></canvas>
  </div>
  <div class="card">
    <h3>최근 입력 데이터</h3>
    <table class="table">
      <thead><tr><th>회원</th><th>월</th><th>출석률</th></tr></thead>
      <tbody>
      {% for row in recent_records %}
        <tr>
          <td>{{ row.member_name }}</td>
          <td>{{ row.month }}</td>
          <td>{{ row.attendance_rate }}</td>
        </tr>
      {% else %}
        <tr><td colspan="3">데이터가 없습니다.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ chart_labels|safe }};
const attendanceData = {{ attendance_data|safe }};
const repurchaseData = {{ repurchase_data|safe }};

new Chart(document.getElementById('kpiChart'), {
  type: 'line',
  data: {
    labels,
    datasets: [
      {
        label: '출석률',
        data: attendanceData,
        borderColor: '#2659ff',
        backgroundColor: 'rgba(38,89,255,.08)',
        tension: .35,
        fill: true
      },
      {
        label: '재구매율',
        data: repurchaseData,
        borderColor: '#12b76a',
        tension: .35
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { legend: { position: 'bottom' } },
    scales: { y: { beginAtZero: true, max: 100 } }
  }
});
</script>
{% endblock %}
